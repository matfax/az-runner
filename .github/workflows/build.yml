name: build and push

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: false

on:
  push:
    branches:
      - main

permissions:
  id-token: write
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest
    environment: azure
    steps:
    - name: checkout code
      uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7

    - name: login to Azure
      uses: azure/login@6c251865b4e6290e7b78be643ea2d005bc51f69a # v2.1.1
      with:
        client-id: ${{ secrets.AZURE_CLIENT_ID }}
        tenant-id: ${{ secrets.AZURE_TENANT_ID }}
        subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
    
    - name: create ACR cache task
      uses: azure/cli@965c8d7571d2231a54e321ddd07f7b10317f34d9 # v2.0.0
      with:
        azcliversion: latest
        inlineScript: |
          az configure --defaults acr=${{ vars.ACR_NAME }}
          az acr build --no-push --no-wait -t cache ./caching

    - name: create ACR build task
      uses: azure/cli@965c8d7571d2231a54e321ddd07f7b10317f34d9 # v2.0.0
      with:
        azcliversion: latest
        inlineScript: |
          az configure --defaults acr=${{ vars.ACR_NAME }}
          az acr build -t az-runner:ubuntu -t az-runner:latest .

  get-token:
    runs-on: ubuntu-latest
    environment: runner-token
    needs: build
    outputs:
      registration-token: ${{ steps.request_token.outputs.registration-token }}
    steps:
      - uses: mcbenjemaa/gh-request-token@946f12468656cbc8b2530c693e0acf429473378c # renovate: tag=v1.0.0
        id: request_token
        with:
          token: ${{ secrets.TOKEN }}

  create:
    name: create test runner
    runs-on: ubuntu-latest
    environment: azure-test
    needs: get-token
    steps:
    - name: login to Azure
      uses: azure/login@6c251865b4e6290e7b78be643ea2d005bc51f69a # v2.1.1
      with:
        client-id: ${{ secrets.AZURE_CLIENT_ID }}
        tenant-id: ${{ secrets.AZURE_TENANT_ID }}
        subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

    - name: create container
      uses: azure/cli@965c8d7571d2231a54e321ddd07f7b10317f34d9 # v2.0.0
      with:
        azcliversion: latest
        inlineScript: |
            az container create \
            --resource-group ${{ vars.RES_GROUP }} \
            --name az-runner-test \
            --location ${{ vars.LOCATION }} \
            --image ${{ vars.ACR_NAME }}.azurecr.io/az-runner \
            --registry-username ${{ vars.ACR_USERNAME }} \
            --registry-password ${{ secrets.ACR_PASSWORD }} \
            --registry-login-server ${{ vars.ACR_NAME }}.azurecr.io \
            --restart-policy Never \
            --cpu 1 \
            --memory 2 \
            --os-type Linux \
            --environment-variables \
                'REPO_URL'='${{ github.server_url }}/${{ github.repository }}' \
                'RUNNER_NAME'='az-runner-test' \
                'RUNNER_SCOPE'='repo' \
                'LABELS'='linux,x64,azure' \
                'EPHEMERAL'='1' \
            --secure-environment-variables \
                'RUNNER_TOKEN'='${{ needs.get-token.outputs.registration-token }}' \
            --no-wait

  test:
    name: test runner
    runs-on:
      - self-hosted
      - azure
    needs: create
    steps:
    - name: checkout code
      uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7
