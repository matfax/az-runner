name: build and push

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: false

on:
  push:
    branches:
      - main

permissions:
  id-token: write
  contents: read

jobs:
  build:
    uses: ./.github/workflows/cli.yml
    secrets: inherit
    with:
      environment: azure
      script: |
        az acr build --no-push --no-wait -t cache ./caching
        az acr build -t az-runner:ubuntu -t az-runner:latest .

  get-token:
    name: fetch registration token
    runs-on: ubuntu-latest
    environment: runner-token
    needs: build
    outputs:
      encrypted-token: ${{ steps.encrypt.outputs.encrypted-token }}
    steps:
      - uses: mcbenjemaa/gh-request-token@946f12468656cbc8b2530c693e0acf429473378c # v1.0.0
        id: request_token
        with:
          token: ${{ secrets.TOKEN }}
      - name: print token
        run: echo "::add-mask::${{ steps.request_token.outputs.registration-token }}"
      - name: encrypt token
        id: encrypt
        shell: pwsh
        run: |
          $securePassword = ConvertTo-SecureString "${{ steps.request_token.outputs.registration-token }}" -AsPlainText -Force
          $secureKey = ConvertTo-SecureString "${{ secrets.SEC_PW }}" -AsPlainText -Force
          $encryptedPassword = ConvertFrom-SecureString $securePassword -SecureKey $secureKey
          echo "encrypted-token=$encryptedPassword" | Out-File -FilePath $Env:GITHUB_OUTPUT -Encoding utf8 -Append

  create:
    name: create test runner
    uses: ./.github/workflows/powershell.yml
    needs: get-token
    secrets: inherit
    with:
      environment: azure-test
      script: ./create.ps1 \
        -ContainerGroupName az-runner-test \
        -RunnerToken (ConvertTo-SecureString -String "${{ needs.get-token.outputs.encrypted-token }}" -SecureKey (ConvertTo-SecureString "${{ secrets.SEC_PW }}" -AsPlainText -Force))

  test:
    name: try test runner
    runs-on:
      - self-hosted
      - azure
    needs: create
    steps:
    - name: checkout code
      uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7

  delete:
    name: delete test runner
    uses: ./.github/workflows/powershell.yml
    needs: test
    secrets: inherit
    with:
      environment: azure-test
      script: ./delete.ps1 -ContainerGroupName az-runner-test
